#!/bin/bash

# Script para atualizar ambiente TEST com c√≥digo do ambiente DEV
# M√©todo: Container para Container (local)
# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîÑ Atualizando ambiente TEST com c√≥digo do DEV${NC}"
echo "=================================================="

# ========================================
# FUN√á√ÉO: Fazer backup do TEST atual
# ========================================
backup_test_current() {
    echo -e "${BLUE}üíæ Fazendo backup do TEST atual...${NC}"
    
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_DIR="backup_test_${TIMESTAMP}"
    
    mkdir -p "$BACKUP_DIR"
    cp -r src/ "$BACKUP_DIR/" 2>/dev/null || true
    cp pom.xml "$BACKUP_DIR/" 2>/dev/null || true
    
    echo -e "${GREEN}‚úÖ Backup TEST criado: $BACKUP_DIR${NC}"
}

# ========================================
# FUN√á√ÉO: Verificar sa√∫de do TEST
# ========================================
check_test_health() {
    echo -e "${BLUE}üîç Verificando sa√∫de do TEST...${NC}"
    
    sleep 15  # Aguardar inicializa√ß√£o
    
    if curl -f http://localhost:8086/api/status > /dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ TEST funcionando: http://localhost:8086${NC}"
        return 0
    else
        echo -e "${RED}‚ùå TEST com problemas!${NC}"
        echo -e "${YELLOW}üí° Verificar logs: sudo docker-compose logs app-test${NC}"
        return 1
    fi
}

# ========================================
# FUN√á√ÉO: Mostrar diferen√ßas entre ambientes
# ========================================
show_environments_diff() {
    echo -e "${BLUE}üìä Status dos ambientes ap√≥s atualiza√ß√£o:${NC}"
    echo "  üîß DEV:  C√≥digo original (inalterado)"
    echo "  üß™ TEST: C√≥digo atualizado do DEV ‚Üê ATUALIZADO"  
    echo "  üöÄ PROD: C√≥digo original (inalterado)"
    echo ""
    echo -e "${YELLOW}URLs para comparar:${NC}"
    echo "  DEV:  http://localhost:8085"
    echo "  TEST: http://localhost:8086 ‚Üê TESTE AQUI"
    echo "  PROD: http://localhost:8087"
}

# ========================================
# FUN√á√ÉO: Executar testes unit√°rios no TEST
# ========================================
run_tests_on_test() {
    echo -e "${BLUE}üß™ Executando testes unit√°rios no ambiente TEST...${NC}"
    
    if sudo docker exec tarefa-app-test ./mvnw test 2>/dev/null; then
        echo -e "${GREEN}‚úÖ Todos os testes passaram no TEST!${NC}"
        return 0
    else
        echo -e "${RED}‚ùå Alguns testes falharam no TEST!${NC}"
        echo -e "${YELLOW}üí° Para ver detalhes: sudo docker exec -it tarefa-app-test ./mvnw test${NC}"
        return 1
    fi
}

# ========================================
# FUN√á√ÉO: Reverter TEST para backup
# ========================================
revert_test() {
    echo -e "${BLUE}üîÑ Listando backups do TEST...${NC}"
    
    BACKUPS=($(ls -d backup_test_* 2>/dev/null | sort -r))
    
    if [ ${#BACKUPS[@]} -eq 0 ]; then
        echo -e "${RED}‚ùå Nenhum backup do TEST encontrado!${NC}"
        return 1
    fi
    
    echo "Backups dispon√≠veis:"
    for i in "${!BACKUPS[@]}"; do
        echo "$((i+1)). ${BACKUPS[$i]}"
    done
    
    read -p "Escolha o backup (n√∫mero): " choice
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#BACKUPS[@]}" ]; then
        SELECTED_BACKUP="${BACKUPS[$((choice-1))]}"
        
        echo -e "${BLUE}üîÑ Revertendo TEST para: $SELECTED_BACKUP${NC}"
        
        # Restaurar arquivos
        cp -r "$SELECTED_BACKUP/src/" ./ 2>/dev/null || true
        cp "$SELECTED_BACKUP/pom.xml" ./ 2>/dev/null || true
        
        # Rebuild TEST
        echo -e "${BLUE}üèóÔ∏è Reconstruindo container TEST...${NC}"
        sudo docker-compose stop app-test
        sudo docker-compose build --no-cache app-test
        sudo docker-compose up -d app-test
        
        echo -e "${GREEN}‚úÖ TEST revertido com sucesso!${NC}"
        check_test_health
    else
        echo -e "${RED}‚ùå Op√ß√£o inv√°lida!${NC}"
    fi
}

# ========================================
# FUN√á√ÉO: Aplicar migra√ß√µes de banco no TEST
# ========================================
apply_database_migrations_test() {
    echo -e "${BLUE}üóÑÔ∏è Aplicando migra√ß√µes de banco no TEST...${NC}"
    
    # 1. Copiar migra√ß√µes do container DEV (se existirem)
    TEMP_MIGRATIONS="temp_migrations_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$TEMP_MIGRATIONS"
    
    # Extrair scripts de migra√ß√£o do DEV
    sudo docker cp tarefa-app-dev:/app/database/migrations.sql "$TEMP_MIGRATIONS/" 2>/dev/null || echo -e "${YELLOW}‚ÑπÔ∏è Nenhuma migra√ß√£o padr√£o encontrada${NC}"
    sudo docker cp tarefa-app-dev:/app/scripts "$TEMP_MIGRATIONS/" 2>/dev/null || echo -e "${YELLOW}‚ÑπÔ∏è Nenhum script customizado encontrado${NC}"
    
    # 2. Aplicar migra√ß√µes no banco TEST
    if [ -f "$TEMP_MIGRATIONS/migrations.sql" ]; then
        echo -e "${BLUE}üìù Aplicando migra√ß√µes estruturais no TEST...${NC}"
        
        # Copiar arquivo para container e executar
        sudo docker cp "$TEMP_MIGRATIONS/migrations.sql" postgres-test:/tmp/migrations.sql
        
        if sudo docker exec postgres-test psql -U test_user -d tarefa_test -f /tmp/migrations.sql 2>/dev/null; then
            echo -e "${GREEN}‚úÖ Migra√ß√µes aplicadas no banco TEST${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è Migra√ß√µes j√° aplicadas ou erro menor${NC}"
        fi
        
        # Limpar arquivo tempor√°rio do container
        sudo docker exec postgres-test rm -f /tmp/migrations.sql 2>/dev/null || true
    fi
    
    # 3. Scripts customizados
    if [ -d "$TEMP_MIGRATIONS/scripts" ]; then
        echo -e "${BLUE}üìù Aplicando scripts customizados no TEST...${NC}"
        
        for script in "$TEMP_MIGRATIONS/scripts"/*.sql; do
            if [ -f "$script" ]; then
                filename=$(basename "$script")
                sudo docker cp "$script" postgres-test:/tmp/"$filename"
                sudo docker exec postgres-test psql -U test_user -d tarefa_test -f /tmp/"$filename" 2>/dev/null || true
                sudo docker exec postgres-test rm -f /tmp/"$filename" 2>/dev/null || true
                echo -e "${GREEN}‚úÖ Script aplicado: $filename${NC}"
            fi
        done
    fi
    
    # Limpar arquivos tempor√°rios
    rm -rf "$TEMP_MIGRATIONS"
}

# ========================================
# FUN√á√ÉO: Backup do banco TEST
# ========================================
backup_database_test() {
    echo -e "${BLUE}üíæ Fazendo backup do banco TEST...${NC}"
    
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="backup_db_test_${TIMESTAMP}.sql"
    
    # Fazer dump do banco TEST preservando dados
    if sudo docker exec postgres-test pg_dump -U test_user tarefa_test > "$BACKUP_FILE"; then
        echo -e "${GREEN}‚úÖ Backup do banco TEST criado: $BACKUP_FILE${NC}"
        return 0
    else
        echo -e "${RED}‚ùå Erro ao fazer backup do banco TEST${NC}"
        return 1
    fi
}

# ========================================
# FUN√á√ÉO: Verificar diferen√ßas estruturais entre DEV e TEST
# ========================================
check_database_differences() {
    echo -e "${BLUE}üîç Verificando diferen√ßas estruturais entre DEV e TEST...${NC}"
    
    # Obter estrutura das tabelas do DEV
    DEV_STRUCTURE=$(sudo docker exec postgres-dev psql -U dev_user -d tarefa_dev -c "\d+" -t 2>/dev/null | head -20)
    
    # Obter estrutura das tabelas do TEST  
    TEST_STRUCTURE=$(sudo docker exec postgres-test psql -U test_user -d tarefa_test -c "\d+" -t 2>/dev/null | head -20)
    
    if [ "$DEV_STRUCTURE" != "$TEST_STRUCTURE" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è Estruturas diferentes detectadas entre DEV e TEST${NC}"
        echo -e "${BLUE}üí° Migra√ß√µes ser√£o aplicadas para sincronizar${NC}"
        return 1
    else
        echo -e "${GREEN}‚úÖ Estruturas de banco sincronizadas${NC}"
        return 0
    fi
}
transfer_dev_to_test() {
    echo -e "${BLUE}üì¶ Transferindo c√≥digo do container DEV para TEST...${NC}"
    
    # 1. Verificar se container DEV est√° rodando
    echo -e "${BLUE}1Ô∏è‚É£ Verificando container DEV...${NC}"
    if ! sudo docker ps --format "table {{.Names}}" | grep -q "tarefa-app-dev"; then
        echo -e "${RED}‚ùå Container DEV n√£o est√° rodando!${NC}"
        echo -e "${YELLOW}üí° Execute: ./start-pipeline.sh ‚Üí Op√ß√£o 1 (Iniciar DEV)${NC}"
        return 1
    fi
    echo -e "${GREEN}‚úÖ Container DEV est√° rodando${NC}"
    
    # 2. Criar diret√≥rio tempor√°rio
    TEMP_DIR="temp_transfer_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$TEMP_DIR"
    echo -e "${GREEN}‚úÖ Diret√≥rio tempor√°rio criado: $TEMP_DIR${NC}"
    
    # 3. Extrair c√≥digo do container DEV
    echo -e "${BLUE}2Ô∏è‚É£ Extraindo c√≥digo do container DEV...${NC}"
    
    if sudo docker cp tarefa-app-dev:/app/src "$TEMP_DIR/"; then
        echo -e "${GREEN}‚úÖ C√≥digo fonte extra√≠do${NC}"
    else
        echo -e "${RED}‚ùå Erro ao extrair c√≥digo fonte${NC}"
        rm -rf "$TEMP_DIR"
        return 1
    fi
    
    if sudo docker cp tarefa-app-dev:/app/pom.xml "$TEMP_DIR/"; then
        echo -e "${GREEN}‚úÖ pom.xml extra√≠do${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è pom.xml n√£o encontrado (continuando...)${NC}"
    fi
    
    # Tentar extrair target (compilado) - opcional
    sudo docker cp tarefa-app-dev:/app/target "$TEMP_DIR/" 2>/dev/null && echo -e "${GREEN}‚úÖ Target extra√≠do${NC}" || echo -e "${YELLOW}‚ÑπÔ∏è Target n√£o extra√≠do (ser√° recompilado)${NC}"
    
    # 4. Fazer backup do TEST atual (c√≥digo E banco)
    echo -e "${BLUE}3Ô∏è‚É£ Fazendo backup do TEST atual...${NC}"
    backup_test_current
    backup_database_test
    
    # 5. Verificar e aplicar migra√ß√µes de banco
    echo -e "${BLUE}4Ô∏è‚É£ Verificando estrutura de banco...${NC}"
    check_database_differences
    apply_database_migrations_test
    
    # 6. Parar container TEST
    echo -e "${BLUE}5Ô∏è‚É£ Parando container TEST...${NC}"
    sudo docker-compose stop app-test
    echo -e "${GREEN}‚úÖ Container TEST parado${NC}"
    
    # 7. Atualizar c√≥digo local
    echo -e "${BLUE}6Ô∏è‚É£ Atualizando c√≥digo local...${NC}"
    
    if [ -d "$TEMP_DIR/src" ]; then
        cp -r "$TEMP_DIR/src" ./
        echo -e "${GREEN}‚úÖ C√≥digo fonte atualizado${NC}"
    else
        echo -e "${RED}‚ùå C√≥digo fonte n√£o encontrado!${NC}"
        rm -rf "$TEMP_DIR"
        return 1
    fi
    
    if [ -f "$TEMP_DIR/pom.xml" ]; then
        cp "$TEMP_DIR/pom.xml" ./
        echo -e "${GREEN}‚úÖ pom.xml atualizado${NC}"
    fi
    
    # 8. Reconstruir container TEST
    echo -e "${BLUE}7Ô∏è‚É£ Reconstruindo container TEST...${NC}"
    if sudo docker-compose build --no-cache app-test; then
        echo -e "${GREEN}‚úÖ Container TEST reconstru√≠do${NC}"
    else
        echo -e "${RED}‚ùå Erro ao reconstruir container TEST${NC}"
        rm -rf "$TEMP_DIR"
        return 1
    fi
    
    # 9. Iniciar container TEST
    echo -e "${BLUE}8Ô∏è‚É£ Iniciando container TEST...${NC}"
    if sudo docker-compose up -d app-test; then
        echo -e "${GREEN}‚úÖ Container TEST iniciado${NC}"
    else
        echo -e "${RED}‚ùå Erro ao iniciar container TEST${NC}"
        rm -rf "$TEMP_DIR"
        return 1
    fi
    
    # 9. Limpar arquivos tempor√°rios
    rm -rf "$TEMP_DIR"
    echo -e "${GREEN}‚úÖ Arquivos tempor√°rios limpos${NC}"
    
    # 11. Verificar sa√∫de
    echo -e "${BLUE}9Ô∏è‚É£ Verificando sa√∫de do TEST...${NC}"
    if check_test_health; then
        echo -e "${GREEN}üéâ Transfer√™ncia conclu√≠da com sucesso!${NC}"
        show_environments_diff
        return 0
    else
        echo -e "${RED}‚ùå Transfer√™ncia conclu√≠da, mas TEST com problemas${NC}"
        return 1
    fi
}

# ========================================
# MENU SIMPLIFICADO
# ========================================
show_menu() {
    echo ""
    echo -e "${YELLOW}Escolha uma op√ß√£o:${NC}"
    echo "1. üîÑ Transferir c√≥digo DEV ‚Üí TEST"
    echo "2. üß™ Executar testes no TEST"
    echo "3. üìä Ver status dos ambientes"
    echo "4. üìù Ver logs do TEST"
    echo "5. üîÑ Reverter TEST (usar backup)"
    echo "6. üßπ Limpar backups antigos"
    echo "7. üö™ Sair"
    echo ""
}

# ========================================
# FUN√á√ÉO: Limpar backups antigos
# ========================================
clean_old_backups() {
    echo -e "${BLUE}üßπ Limpando backups antigos do TEST...${NC}"
    
    BACKUPS=($(ls -d backup_test_* 2>/dev/null | sort -r))
    
    if [ ${#BACKUPS[@]} -gt 5 ]; then
        echo -e "${YELLOW}üì¶ Mantendo apenas os 5 backups mais recentes...${NC}"
        for ((i=5; i<${#BACKUPS[@]}; i++)); do
            rm -rf "${BACKUPS[$i]}"
            echo -e "${GREEN}üóëÔ∏è  Removido: ${BACKUPS[$i]}${NC}"
        done
        echo -e "${GREEN}‚úÖ Limpeza conclu√≠da${NC}"
    else
        echo -e "${YELLOW}üí° Menos de 5 backups, nada para limpar${NC}"
    fi
}

# ========================================
# EXECU√á√ÉO PRINCIPAL
# ========================================
if [ $# -eq 0 ]; then
    # Menu interativo
    while true; do
        show_menu
        read -p "Digite sua op√ß√£o (1-7): " option
        
        case $option in
            1) transfer_dev_to_test ;;
            2) run_tests_on_test ;;
            3) sudo docker-compose ps ;;
            4) sudo docker-compose logs -f app-test ;;
            5) revert_test ;;
            6) clean_old_backups ;;
            7) 
                echo -e "${GREEN}üëã At√© logo!${NC}"
                exit 0
                ;;
            *) 
                echo -e "${RED}‚ùå Op√ß√£o inv√°lida!${NC}"
                ;;
        esac
        echo ""
        read -p "Pressione Enter para continuar..."
    done
else
    # Execu√ß√£o direta
    case $1 in
        "transfer") transfer_dev_to_test ;;
        "test") run_tests_on_test ;;
        "revert") revert_test ;;
        "clean") clean_old_backups ;;
        *) 
            echo -e "${YELLOW}Uso: $0 [transfer|test|revert|clean]${NC}"
            echo "Ou execute sem par√¢metros para menu interativo"
            ;;
    esac
fi